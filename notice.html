<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê³µì§€ì‚¬í•­</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 15px;
      margin-right: 5px;
      background-color: #87CEFA;
      border: none;
      cursor: pointer;
    }
    .notice {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 15px;
    }
    .notice small {
      display: block;
      margin-bottom: 8px;
      color: gray;
    }
    .filter-box {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
  </style>
</head>
<body onload="loadNotices()">
  <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>

  <!-- ë“±ë¡ í¼ -->
  <div id="noticeForm">
    <input type="text" id="noticeTitle" placeholder="ì œëª© ì…ë ¥" />
    <textarea id="noticeContent" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
    <input type="password" id="noticePassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ìˆ˜ì •/ì‚­ì œìš©)" />
    <input type="file" id="noticeFile" />
    <button onclick="addNotice()">ê³µì§€ ë“±ë¡</button>
  </div>

  <!-- ê²€ìƒ‰ ë° í•„í„° -->
  <div class="filter-box">
    <input type="text" id="searchKeyword" placeholder="ì œëª©/ë‚´ìš© ê²€ìƒ‰" oninput="loadNotices()" />
    <input type="date" id="filterDate" onchange="loadNotices()" />
    <button onclick="resetFilters()">í•„í„° ì´ˆê¸°í™”</button>
  </div>

  <!-- ê³µì§€ ë¦¬ìŠ¤íŠ¸ -->
  <h3>ğŸ“œ ë“±ë¡ëœ ê³µì§€ì‚¬í•­</h3>
  <div id="noticeList"></div>

  <button onclick="location.href='home.html'">ğŸ  í™ˆìœ¼ë¡œ</button>

  <script>
    function getCurrentUser() {
      return JSON.parse(localStorage.getItem('loggedInUser'));
    }

    function resetFilters() {
      document.getElementById("searchKeyword").value = "";
      document.getElementById("filterDate").value = "";
      loadNotices();
    }

    function loadNotices() {
      const user = getCurrentUser();
      if (!user) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        location.href = "index.html";
        return;
      }

      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();
      const dateFilter = document.getElementById("filterDate").value;
      const list = document.getElementById("noticeList");
      const notices = JSON.parse(localStorage.getItem("notices") || "[]");
      list.innerHTML = "";

      let filtered = notices;

      if (keyword) {
        filtered = filtered.filter(n =>
          n.title.toLowerCase().includes(keyword) ||
          n.content.toLowerCase().includes(keyword)
        );
      }

      if (dateFilter) {
        filtered = filtered.filter(n =>
          n.date && n.date.startsWith(dateFilter)
        );
      }

      if (filtered.length === 0) {
        list.innerHTML = "<p>ì¡°ê±´ì— ë§ëŠ” ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      filtered.slice().reverse().forEach((n, i) => {
        const index = notices.indexOf(n); // ì›ë³¸ ì¸ë±ìŠ¤
        const el = document.createElement("div");
        el.className = "notice";
        el.innerHTML = `
          <strong>${n.title}</strong>
          <small>ì‘ì„±ì: ${n.author} | ì‘ì„±ì¼: ${n.date}</small>
          <p>${n.content}</p>
          ${n.fileName ? `<p>ì²¨ë¶€íŒŒì¼: <a href="${n.fileData}" download="${n.fileName}">${n.fileName}</a></p>` : ''}
          <button onclick="editNotice(${index})">âœï¸ ìˆ˜ì •</button>
          <button onclick="deleteNotice(${index})">ğŸ—‘ï¸ ì‚­ì œ</button>
        `;
        list.appendChild(el);
      });
    }

    function addNotice() {
      const user = getCurrentUser();
      const title = document.getElementById("noticeTitle").value.trim();
      const content = document.getElementById("noticeContent").value.trim();
      const password = document.getElementById("noticePassword").value.trim();
      const fileInput = document.getElementById("noticeFile");
      const file = fileInput.files[0];

      if (!title || !content || !password) {
        alert("ì œëª©, ë‚´ìš©, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const notices = JSON.parse(localStorage.getItem("notices") || "[]");

      const newNotice = {
        title,
        content,
        date: new Date().toISOString().slice(0, 16).replace('T', ' '), // YYYY-MM-DD HH:mm
        author: user.name,
        password,
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          newNotice.fileName = file.name;
          newNotice.fileData = e.target.result;

          notices.push(newNotice);
          localStorage.setItem("notices", JSON.stringify(notices));
          clearForm();
          loadNotices();
        };
        reader.readAsDataURL(file);
      } else {
        notices.push(newNotice);
        localStorage.setItem("notices", JSON.stringify(notices));
        clearForm();
        loadNotices();
      }
    }

    function clearForm() {
      document.getElementById("noticeTitle").value = "";
      document.getElementById("noticeContent").value = "";
      document.getElementById("noticePassword").value = "";
      document.getElementById("noticeFile").value = "";
    }

    function deleteNotice(index) {
      const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‚­ì œ)");
      const notices = JSON.parse(localStorage.getItem("notices") || "[]");

      if (notices[index].password === pw) {
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          notices.splice(index, 1);
          localStorage.setItem("notices", JSON.stringify(notices));
          loadNotices();
        }
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }

    function editNotice(index) {
      const notices = JSON.parse(localStorage.getItem("notices") || "[]");
      const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìˆ˜ì •)");

      if (notices[index].password !== pw) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const newTitle = prompt("ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", notices[index].title);
      const newContent = prompt("ìƒˆ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", notices[index].content);

      if (newTitle && newContent) {
        notices[index].title = newTitle.trim();
        notices[index].content = newContent.trim();
        notices[index].date = new Date().toISOString().slice(0, 16).replace('T', ' ');
        localStorage.setItem("notices", JSON.stringify(notices));
        loadNotices();
      }
    }
  </script>
</body>
</html>